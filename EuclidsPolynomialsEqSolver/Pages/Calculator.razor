@page "/"
@page "/calculator"
@inherits MathJaxBlazor.MathJaxContentComponent
@inject IJSRuntime JsRuntime

<PageTitle>Calculator</PageTitle>

<h4>Algoritmo extendido de Euclides para polinomios de orden $$\mathbb{Z}_2$$</h4>

<MudPaper Class="pa-4">
    <MudForm @bind-IsValid="@isValid" @ref="form">

        <MudTextField T="string" Label="$$G(x)$$"
                      Required="true"
                      @bind-Value="Gx"
                      Placeholder="x^10 + 2x^1 + 1 + ..."
                      Variant="Variant.Outlined"
                      Validation="@(new Func<string, IEnumerable<string>>(ValidatePolynom))"
                      RequiredError="Debe ingresar un polinomio ecuación válido para $$G(x)$$" />

        <MudTextField T="string" Label="$$F(x)$$"
                      Required="true"
                      @bind-Value="Hx"
                      Placeholder="x^10 + 2x^1 + 1 + ..."
                      Variant="Variant.Outlined"
                      Validation="@(new Func<string, IEnumerable<string>>(ValidatePolynom))"
                      RequiredError="Debe ingresar un polinomio ecuación válido para $$F(x)$$" />
        <div style="height: 20px" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" DisableElevation="true"
                   StartIcon="@Icons.Material.Filled.Calculate" OnClick="@Calculate">Calcular</MudButton>
        <MudButton Variant="Variant.Filled" DisableElevation="true"
                   OnClick="@Clear"
                   StartIcon="@Icons.Material.Filled.RestoreFromTrash">Limpiar</MudButton>

    </MudForm>
</MudPaper>
<div style="height: 3vh"></div>
<h5>Teniendo los siguientes polinomios en $$\mathbb{Z}_2$$</h5>
<div>
    <p id="gx"></p>
</div>

<div>
    <p id="hx"></p>
</div>

<div style="height: 3vh"></div>

<div>
    @if (Solution is { } sol)
    {
        <h5>Calcular</h5>
        <p>$$D(x)=gcd(G(x)$$ , $$H(x)$$ , $$S(x)$$ , $$T(x)$$</p>
        @foreach (Step stepBlock in sol.Steps)
        {
            <div class="step-block">
                @foreach (MarkupString step in stepBlock)
                {
                    <p>@step</p>
                }
                <span class="badge">@stepBlock.GetNumber()</span>
            </div>
        }
    }
</div>

<div style="height: 20vh"></div>




@code {

    PolynomialEq gx { get; set; } = new PolynomialEq('g',
        new XTerm(10),
        new XTerm(9),
        new XTerm(8),
        new XTerm(6),
        new XTerm(5),
        new XTerm(4),
        XTerm.One);

    PolynomialEq hx { get; set; } = new PolynomialEq('h',
        new XTerm(9),
        new XTerm(6),
        new XTerm(5),
        new XTerm(3),
        new XTerm(2),
        XTerm.One);

    ExtendedEuclides? Solution;

    string Gx
    {
        get => gx.IsZero ? "" : gx.ToString(false);
        set
        {
            gx = new PolynomialEq('g');
            if (PolynomialEq.Parse(value, out PolynomialEq eq))
            {
                gx = eq.SetLetter('g');
            }
            JsRuntime.InvokeVoidAsync("setPText", "gx",  gx.ToLatexString().Value);
        }
    }
    string Hx
    {
        get => hx.IsZero ? "" : hx.ToString(false);
        set
        {
            hx = new PolynomialEq('h');
            if (PolynomialEq.Parse(value, out PolynomialEq eq))
            {
                hx = eq.SetLetter('h');
            }
            StateHasChanged();
            JsRuntime.InvokeVoidAsync("setPText", "hx",  hx.ToLatexString().Value);
        }
    }

    MudForm form;
    bool isValid;

    private IEnumerable<string> ValidatePolynom(string value)
    {
        if (!PolynomialEq.Parse(value, out _))
        {
            yield return "El polinomio no es válido";
            yield break;
        }
    }


    private async Task Clear()
    {
        this.gx = new PolynomialEq('g');
        this.hx = new PolynomialEq('h');
        Solution = null;
        await form.Validate();
    }
    private async Task Calculate()
    {
        await form.Validate();
        if (!isValid)
        {
            return;
        }
        Solution = new ExtendedEuclides(gx, hx);
        Solution.Solve();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        if (firstRender)
        {
            JsRuntime.InvokeVoidAsync("setPText", "gx", gx.ToLatexString().Value);
            JsRuntime.InvokeVoidAsync("setPText", "hx", hx.ToLatexString().Value);
        }
    }

}